<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>后缀自动机总结 | foreverlasting's blog</title><meta name="keywords" content="OI"><meta name="author" content="foreverlasting"><meta name="copyright" content="foreverlasting"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="后缀自动机总结。 后缀自动机学了好久了，说实在话，这东西的确是靠做足够多的题才能慢慢理解的，一下子的确比较难以讲懂，但是要讲懂还是有可能的（像hihocoder上的后缀自动机总结）。 所以要有这篇总结呢？一是补全hihocoder上一些没讲到的东西，二是给出一些后缀自动机各种性质的模板题。嗯，先从知识点开始。 如果了解后缀数组的同学就会知道，一个字符串的所有子串是能通过所有后缀的公共前缀所表示出来">
<meta property="og:type" content="article">
<meta property="og:title" content="后缀自动机总结">
<meta property="og:url" content="http://foreverlasting1202.github.io/2018/12/01/%E5%90%8E%E7%BC%80%E8%87%AA%E5%8A%A8%E6%9C%BA%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="foreverlasting&#39;s blog">
<meta property="og:description" content="后缀自动机总结。 后缀自动机学了好久了，说实在话，这东西的确是靠做足够多的题才能慢慢理解的，一下子的确比较难以讲懂，但是要讲懂还是有可能的（像hihocoder上的后缀自动机总结）。 所以要有这篇总结呢？一是补全hihocoder上一些没讲到的东西，二是给出一些后缀自动机各种性质的模板题。嗯，先从知识点开始。 如果了解后缀数组的同学就会知道，一个字符串的所有子串是能通过所有后缀的公共前缀所表示出来">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://pic.imgdb.cn/item/61fa051f2ab3f51d91b7ee03.jpg">
<meta property="article:published_time" content="2018-12-01T06:38:00.000Z">
<meta property="article:modified_time" content="2019-01-13T10:03:38.523Z">
<meta property="article:author" content="foreverlasting">
<meta property="article:tag" content="OI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.imgdb.cn/item/61fa051f2ab3f51d91b7ee03.jpg"><link rel="shortcut icon" href="/img/1.jpg"><link rel="canonical" href="http://foreverlasting1202.github.io/2018/12/01/%E5%90%8E%E7%BC%80%E8%87%AA%E5%8A%A8%E6%9C%BA%E6%80%BB%E7%BB%93/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '后缀自动机总结',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2019-01-13 18:03:38'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.1"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/cute.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">141</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">3</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">40</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> Messageboard</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> Timeline</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/myself/"><i class="fa-fw fa fa-id-card"></i><span> myself</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://pic.imgdb.cn/item/61fa051f2ab3f51d91b7ee03.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">foreverlasting's blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> Messageboard</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> Timeline</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/myself/"><i class="fa-fw fa fa-id-card"></i><span> myself</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">后缀自动机总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2018-12-01T06:38:00.000Z" title="Created 2018-12-01 14:38:00">2018-12-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2019-01-13T10:03:38.523Z" title="Updated 2019-01-13 18:03:38">2019-01-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/">知识点总结</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="后缀自动机总结"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>后缀自动机总结。<br><span id="more"></span></p>
<p>后缀自动机学了好久了，说实在话，这东西的确是靠做足够多的题才能慢慢理解的，一下子的确比较难以讲懂，但是要讲懂还是有可能的（像hihocoder上的后缀自动机总结）。</p>
<p>所以要有这篇总结呢？一是补全hihocoder上一些没讲到的东西，二是给出一些后缀自动机各种性质的模板题。嗯，先从知识点开始。</p>
<p>如果了解后缀数组的同学就会知道，一个字符串的所有子串是能通过所有后缀的公共前缀所表示出来的。对于很多题目而言，如果能够求出一个字符串就能轻松解决。但我们知道子串的个数是$O(n^2)$级别的，我们不好去直接表示。同时，我们发现在一定字符集大小的情况下，一些子串的某些部分是重复的，如果能利用上这些重复部分，那子串就有可能在一定的空间内被表现出来，而后缀自动机恰恰就是利用这些重复部分从而做到表达所有子串的一个有限状态自动机。（关于有限状态自动机的定义大家可以自己去查询或者不管它）</p>
<p>后缀自动机的基本概念大家可以在hihocoder上搜索后缀自动机而找到，这里并不提，主要是要讲一些hihocoder上没有的东西。</p>
<p>一：线段树合并维护$right$集合（即$endpos$集合）。</p>
<p>在有一类问题中，它可能是要让我们确认某个串在主串的某个区间内是否出现过或者其它并不好处理的区间操作时，我们就会考虑$right$集合。如果我们能做到维护$right$集合并且能维护$right$集合串的初始位置就好了，而恰恰这些可以通过线段树合并做到。在我们添加一个字符进入后缀自动机时，对于字符串而言这个字符的位置一定是一个新的$right$集合的结束位置，对于自动机而言这个字符的位置也是一个全新的结束位置。当我们把后缀树建出来的时候，每一条向上的链都代表了一个字符串，且这个字符串的结束位置也是这条链深度最深点的位置。那就好办了，我们自底向上合并，就可以得到$right$集合了。那么一个区间的子串就是初始的点的线段树里的结束位置。往往这个初始的点我们可以通过倍增得到，于是我们就能解决这一类问题了。</p>
<p>倍增+$right$集合模板题：[HEOI2016/TJOI2016]字符串</p>
<p>二：本质不同子串个数</p>
<p>这种问题是非常容易理解和解决的，我们知道后缀自动机的每个状态表示的是$right$集合，而每个$right$集合的集合大小之和一定是本质不同子串个数。集合大小又恰好是这个集合的$longest-shortest$，而在后缀自动机的$shortest$又恰好是$parents$树上父亲的$longest$。所以本质不同子串个数就是$\sum (sam[p].longest-sam[fa[p]].shortest)$。</p>
<p>本质不同子串模板题：SPOJ705，SPOJ694</p>
<p>三：最长公共子串</p>
<p>这就是后缀自动机上跑匹配的模板了。我们知道后缀自动机上从根节点出发的每一条路径都代表这个字符串的一个子串，那应该如何利用这个性质呢？这就是$parents$树的强大之处了。字符串的题一般都是匹配好处理，失配难处理。后缀自动机的匹配很简单，直接沿着$DAG$上的边跳就行了。失配也不难处理，我们只要每次去跳$parents$直到找到匹配就可以了，这样的复杂度显然是$O(len)$的。</p>
<p>最长公共子串模板题：SPOJ7258</p>
<p>四：第k小子串</p>
<p>第k小子串应该分为两种问题，一个是可重，一个是不可重，其实两种毫无区别。我们只要求出每一个状态对答案的贡献就好了，可重的话每一个状态的贡献就是$right$集合的大小，不可重的话就是1。其他就是在上面跑匹配的事情了，上文已经提过。</p>
<p>第k小子串模板题：[TJOI2015]弦论</p>
<p>五：高度数组</p>
<p>。。。建出反串的后缀树，然后贪心地$dfs$求一遍后缀数组，然后就用后缀数组求出高度数组就可以了。说白了就是通过后缀自动机求后缀数组，这样的时间复杂度是$O(len)$的，但空间复杂度是$O(len<em>字符集大小</em>4)$的，只要不爆空间跑得比倍增构造后缀数组快。</p>
<p>以下给出一个模板：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SA</span>&#123;</span></span><br><span class="line">       <span class="keyword">int</span> str[N];</span><br><span class="line">       <span class="class"><span class="keyword">struct</span> <span class="title">SAM</span>&#123;</span></span><br><span class="line">           <span class="keyword">int</span> vis[<span class="number">26</span>],par,len,pos;</span><br><span class="line">           <span class="keyword">bool</span> val;</span><br><span class="line">       &#125;sam[N&lt;&lt;<span class="number">1</span>];</span><br><span class="line">       <span class="keyword">int</span> cnt,rt,las;</span><br><span class="line">       <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">INIT</span><span class="params">()</span></span>&#123;</span><br><span class="line">           cnt=rt=las=<span class="number">1</span>;</span><br><span class="line">           <span class="built_in">memset</span>(sam,<span class="number">0</span>,<span class="built_in"><span class="keyword">sizeof</span></span>(sam));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">extend</span><span class="params">(<span class="keyword">const</span> res &amp;x,<span class="keyword">const</span> res &amp;id)</span></span>&#123;</span><br><span class="line">           res p=las,np=++cnt;</span><br><span class="line">           las=np,sam[np].len=sam[p].len+<span class="number">1</span>,sam[np].pos=id,sam[np].val=<span class="number">1</span>;</span><br><span class="line">           <span class="keyword">for</span>(;p&amp;&amp;!sam[p].vis[x];p=sam[p].par)sam[p].vis[x]=np;</span><br><span class="line">           <span class="keyword">if</span>(!p)sam[np].par=rt;</span><br><span class="line">           <span class="keyword">else</span> &#123;</span><br><span class="line">               res q=sam[p].vis[x];</span><br><span class="line">               <span class="keyword">if</span>(sam[q].len==sam[p].len+<span class="number">1</span>)sam[np].par=q;</span><br><span class="line">               <span class="keyword">else</span> &#123;</span><br><span class="line">                   res nq=++cnt;</span><br><span class="line">                   <span class="built_in">memcpy</span>(sam[nq].vis,sam[q].vis,<span class="built_in"><span class="keyword">sizeof</span></span>(sam[nq].vis));</span><br><span class="line">                   sam[nq].par=sam[q].par,sam[nq].len=sam[p].len+<span class="number">1</span>,sam[nq].pos=sam[q].pos,sam[q].par=sam[np].par=nq;</span><br><span class="line">                   <span class="keyword">for</span>(;p&amp;&amp;sam[p].vis[x]==q;p=sam[p].par)sam[p].vis[x]=nq;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">int</span> rnk[N],sa[N],hei[N],tot,vis[N&lt;&lt;<span class="number">1</span>][<span class="number">26</span>];</span><br><span class="line">       <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">addedge</span><span class="params">(<span class="keyword">const</span> res &amp;u,<span class="keyword">const</span> res &amp;v,<span class="keyword">const</span> res &amp;c)</span></span>&#123;</span><br><span class="line">           vis[u][c]=v;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">build</span><span class="params">()</span></span>&#123;</span><br><span class="line">           <span class="built_in">memset</span>(vis,<span class="number">0</span>,<span class="built_in"><span class="keyword">sizeof</span></span>(vis)),tot=<span class="number">0</span>;</span><br><span class="line">           <span class="keyword">for</span>(res i=<span class="number">2</span>;i&lt;=cnt;i++)<span class="built_in">addedge</span>(sam[i].par,i,str[sam[i].pos+sam[sam[i].par].len]);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">const</span> res &amp;x)</span></span>&#123;</span><br><span class="line">           <span class="keyword">if</span>(sam[x].val)sa[rnk[sam[x].pos]=++tot]=sam[x].pos;</span><br><span class="line">           <span class="keyword">for</span>(res i=<span class="number">0</span>;i&lt;<span class="number">26</span>;i++)<span class="keyword">if</span>(vis[x][i])<span class="built_in">dfs</span>(vis[x][i]);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">get_hei</span><span class="params">()</span></span>&#123;</span><br><span class="line">           res k=<span class="number">0</span>;</span><br><span class="line">           <span class="keyword">for</span>(res i=<span class="number">1</span>;i&lt;=n;i++)rnk[sa[i]]=i;</span><br><span class="line">           <span class="keyword">for</span>(res i=<span class="number">1</span>;i&lt;=n;i++)&#123;</span><br><span class="line">               <span class="keyword">if</span>(rnk[i]==<span class="number">1</span>)<span class="keyword">continue</span>;</span><br><span class="line">               <span class="keyword">if</span>(k)k--;</span><br><span class="line">               res j=sa[rnk[i]<span class="number">-1</span>];</span><br><span class="line">               <span class="keyword">while</span>(j+k&lt;=n&amp;&amp;i+k&lt;=n&amp;&amp;str[i+k]==str[j+k])k++;</span><br><span class="line">               hei[rnk[i]]=k;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">int</span> st[N][<span class="number">21</span>];</span><br><span class="line">       <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">ST</span><span class="params">()</span></span>&#123;</span><br><span class="line">           <span class="built_in">memset</span>(st,inf,<span class="built_in"><span class="keyword">sizeof</span></span>(st));</span><br><span class="line">           <span class="keyword">for</span>(res i=<span class="number">1</span>;i&lt;=n;i++)st[i][<span class="number">0</span>]=hei[i];</span><br><span class="line">           <span class="keyword">for</span>(res j=<span class="number">1</span>;j&lt;=<span class="number">20</span>;j++)</span><br><span class="line">               <span class="keyword">for</span>(res i=<span class="number">1</span>;i+(<span class="number">1</span>&lt;&lt;j)<span class="number">-1</span>&lt;=n;i++)</span><br><span class="line">                   st[i][j]=_min(st[i][j<span class="number">-1</span>],st[i+(<span class="number">1</span>&lt;&lt;(j<span class="number">-1</span>))][j<span class="number">-1</span>]);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">query_min</span><span class="params">(<span class="keyword">const</span> res &amp;l,<span class="keyword">const</span> res &amp;r)</span></span>&#123;</span><br><span class="line">           res k=<span class="built_in">log2</span>(r-l+<span class="number">1</span>);</span><br><span class="line">           <span class="keyword">return</span> _min(st[l][k],st[r-(<span class="number">1</span>&lt;&lt;k)+<span class="number">1</span>][k]);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">LCP</span><span class="params">(<span class="keyword">const</span> res &amp;l,<span class="keyword">const</span> res &amp;r)</span></span>&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="built_in">query_min</span>(_min(rnk[l],rnk[r])+<span class="number">1</span>,_max(rnk[l],rnk[r]));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">pre</span><span class="params">()</span></span>&#123;</span><br><span class="line">           <span class="built_in">INIT</span>();</span><br><span class="line">           <span class="keyword">for</span>(res i=n;i;i--)<span class="built_in">extend</span>(str[i],i);</span><br><span class="line">           <span class="built_in">build</span>(),<span class="built_in">dfs</span>(<span class="number">1</span>),<span class="built_in">get_hei</span>(),<span class="built_in">ST</span>();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;A;</span><br></pre></td></tr></table></figure></p>
<p>六：多串匹配</p>
<p>说白了就是广义后缀自动机。广义后缀自动机其实是很好建的，一个字符的结束位置一定是下一个字符的起始位置。这也是为什么多串匹配的时候我们要根节点的位置作为起始位置，这也是为什么在某些题中我们边搜索边建后缀自动机，其实和普通的建法没什么区别。</p>
<p>多串匹配模板题：SPOJ8093，[USACO17DEC]Standing Out from the Herd</p>
<p>边搜边建模板题：[ZJOI2015]诸神眷顾的幻想乡，[bzoj2894]世界线</p>
<p>七：区间本质不同子串</p>
<p>补充一个黑科技，具体可以参照laofu的集训队论文。</p>
<p>先考虑一个问题，如果不是询问区间本质不同子串，而是询问区间不同数的个数怎么做。</p>
<p>这显然可以用线段树维护，这具体怎么维护想必就不用讲了，相信大家都会。</p>
<p>再考虑子串怎么维护。</p>
<p>后缀自动机上一个结点代表的串的出现次数都是相同的，我们可以一起统计。</p>
<p>在末尾加入一个字符后，所有重复出现的串为新建节点np在parent树上的所有祖先。</p>
<p>在后缀自动机上一个结点上我们记一个串出现的最后位置last，一次操作我们需要把np的所有父亲的last全部修改。</p>
<p>而这个操作不正好是LCT的access吗，于是复杂度就变成$O(n{log^2n})$。</p>
<p>给出一个模板：</p>
<h2 id=""><a href="#" class="headerlink" title=""></a><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">SAM</span>&#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">Sam</span>&#123;</span></span><br><span class="line">			<span class="keyword">int</span> vis[<span class="number">26</span>],par,len,pos;</span><br><span class="line">		&#125;sam[N&lt;&lt;<span class="number">1</span>];</span><br><span class="line">		<span class="keyword">int</span> las,rt,cnt;</span><br><span class="line">		<span class="built_in">SAM</span>() &#123;las=rt=cnt=<span class="number">1</span>;&#125;</span><br><span class="line">		<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">extend</span><span class="params">(<span class="keyword">const</span> res &amp;x,<span class="keyword">const</span> res &amp;id)</span></span>&#123;</span><br><span class="line">            res p=las,np=++cnt;</span><br><span class="line">            las=np,sam[np].len=sam[p].len+<span class="number">1</span>,pos[id]=las;</span><br><span class="line">            <span class="keyword">for</span>(;p&amp;&amp;!sam[p].vis[x];p=sam[p].par)sam[p].vis[x]=np;</span><br><span class="line">            <span class="keyword">if</span>(!p)sam[np].par=rt;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                res q=sam[p].vis[x];</span><br><span class="line">                <span class="keyword">if</span>(sam[q].len==sam[p].len+<span class="number">1</span>)sam[np].par=q;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    res nq=++cnt;</span><br><span class="line">                    <span class="built_in">memcpy</span>(sam[nq].vis,sam[q].vis,<span class="built_in"><span class="keyword">sizeof</span></span>(sam[nq].vis));</span><br><span class="line">                    sam[nq].len=sam[p].len+<span class="number">1</span>;</span><br><span class="line">                    sam[nq].par=sam[q].par;</span><br><span class="line">                    sam[q].par=sam[np].par=nq;</span><br><span class="line">                    <span class="keyword">for</span>(;p&amp;&amp;sam[p].vis[x]==q;p=sam[p].par)sam[p].vis[x]=nq;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;A;</span><br><span class="line">	<span class="keyword">typedef</span> pair&lt;<span class="keyword">int</span>,<span class="keyword">int</span>&gt; Pair;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fi first</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> se second</span></span><br><span class="line">	<span class="keyword">int</span> q;</span><br><span class="line">	LL ans[N];</span><br><span class="line">	vector&lt;Pair&gt; vec[N];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pb push_back</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Seg</span>&#123;</span></span><br><span class="line">		LL sum[N&lt;&lt;<span class="number">2</span>];</span><br><span class="line">		<span class="keyword">int</span> add[N&lt;&lt;<span class="number">2</span>],len[N&lt;&lt;<span class="number">2</span>];</span><br><span class="line">		<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">pushup</span><span class="params">(<span class="keyword">const</span> res &amp;rt)</span></span>&#123;</span><br><span class="line">			sum[rt]=sum[rt&lt;&lt;<span class="number">1</span>]+sum[rt&lt;&lt;<span class="number">1</span>|<span class="number">1</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(<span class="keyword">const</span> res &amp;rt,<span class="keyword">const</span> res &amp;val)</span></span>&#123;</span><br><span class="line">			sum[rt]+=<span class="number">1LL</span>*val*len[rt],add[rt]+=val;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">pushdown</span><span class="params">(<span class="keyword">const</span> res &amp;rt)</span></span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(!add[rt])<span class="keyword">return</span>;</span><br><span class="line">			<span class="built_in">change</span>(rt&lt;&lt;<span class="number">1</span>,add[rt]),<span class="built_in">change</span>(rt&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,add[rt]),add[rt]=<span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">const</span> res &amp;rt,<span class="keyword">const</span> res &amp;l,<span class="keyword">const</span> res &amp;r)</span></span>&#123;</span><br><span class="line">			len[rt]=r-l+<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span>(l==r)<span class="keyword">return</span>;</span><br><span class="line">			res mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">			<span class="built_in">build</span>(rt&lt;&lt;<span class="number">1</span>,l,mid),<span class="built_in">build</span>(rt&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">modify</span><span class="params">(<span class="keyword">const</span> res &amp;rt,<span class="keyword">const</span> res &amp;l,<span class="keyword">const</span> res &amp;r,<span class="keyword">const</span> res &amp;L,<span class="keyword">const</span> res &amp;R,<span class="keyword">const</span> res &amp;val)</span></span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(L&gt;R)<span class="keyword">return</span>;</span><br><span class="line">			<span class="keyword">if</span>(L&lt;=l&amp;&amp;r&lt;=R)&#123;<span class="built_in">change</span>(rt,val);<span class="keyword">return</span>;&#125;</span><br><span class="line">			<span class="built_in">pushdown</span>(rt);</span><br><span class="line">			res mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span>(L&lt;=mid)<span class="built_in">modify</span>(rt&lt;&lt;<span class="number">1</span>,l,mid,L,R,val);</span><br><span class="line">			<span class="keyword">if</span>(R&gt;mid)<span class="built_in">modify</span>(rt&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r,L,R,val);</span><br><span class="line">			<span class="built_in">pushup</span>(rt);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function">LL <span class="title">query</span><span class="params">(<span class="keyword">const</span> res &amp;rt,<span class="keyword">const</span> res &amp;l,<span class="keyword">const</span> res &amp;r,<span class="keyword">const</span> res &amp;L,<span class="keyword">const</span> res &amp;R)</span></span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(L&gt;R)<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span>(L&lt;=l&amp;&amp;r&lt;=R)<span class="keyword">return</span> sum[rt];</span><br><span class="line">			<span class="built_in">pushdown</span>(rt);</span><br><span class="line">			res mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">			LL ret=<span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span>(L&lt;=mid)ret+=<span class="built_in">query</span>(rt&lt;&lt;<span class="number">1</span>,l,mid,L,R);</span><br><span class="line">			<span class="keyword">if</span>(R&gt;mid)ret+=<span class="built_in">query</span>(rt&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r,L,R);</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;B;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">LCT</span>&#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">Lct</span>&#123;</span></span><br><span class="line">			<span class="keyword">int</span> son[<span class="number">2</span>],sz,fa,mn,mx,mxlen,mnlen,col;</span><br><span class="line">			<span class="keyword">bool</span> rev;</span><br><span class="line">		&#125;tr[N];</span><br><span class="line">		<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">pushup</span><span class="params">(<span class="keyword">const</span> res &amp;x)</span></span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(!x)<span class="keyword">return</span>;</span><br><span class="line">			res ls=tr[x].son[<span class="number">0</span>],rs=tr[x].son[<span class="number">1</span>];</span><br><span class="line">			tr[x].sz=tr[ls].sz+tr[rs].sz+<span class="number">1</span>;</span><br><span class="line">			tr[x].mx=_max(_max(tr[ls].mx,tr[rs].mx),tr[x].mxlen);</span><br><span class="line">			tr[x].mn=_min(_min(tr[ls].mn,tr[rs].mn),tr[x].mnlen);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">reversed</span><span class="params">(<span class="keyword">const</span> res &amp;x)</span></span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(!x)<span class="keyword">return</span>;</span><br><span class="line">			res &amp;ls=tr[x].son[<span class="number">0</span>],&amp;rs=tr[x].son[<span class="number">1</span>];</span><br><span class="line">			_swap(ls,rs),tr[x].rev^=<span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">pushdown</span><span class="params">(<span class="keyword">const</span> res &amp;x)</span></span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(!x||!tr[x].rev)<span class="keyword">return</span>;</span><br><span class="line">			res ls=tr[x].son[<span class="number">0</span>],rs=tr[x].son[<span class="number">1</span>];</span><br><span class="line">			<span class="built_in">reversed</span>(ls),<span class="built_in">reversed</span>(rs),tr[x].rev=<span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">nroot</span><span class="params">(<span class="keyword">const</span> res &amp;x)</span> </span>&#123;</span><br><span class="line">        	<span class="keyword">return</span> tr[tr[x].fa].son[<span class="number">0</span>]==x||tr[tr[x].fa].son[<span class="number">1</span>]==x;</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">rotate</span><span class="params">(<span class="keyword">const</span> res &amp;x)</span> </span>&#123;</span><br><span class="line">        	res y=tr[x].fa,z=tr[y].fa,k=tr[y].son[<span class="number">1</span>]==x,w=tr[x].son[k^<span class="number">1</span>];</span><br><span class="line">        	<span class="keyword">if</span>(<span class="built_in">nroot</span>(y))tr[z].son[tr[z].son[<span class="number">1</span>]==y]=x;</span><br><span class="line">        	tr[x].son[k^<span class="number">1</span>]=y,tr[y].son[k]=w;</span><br><span class="line">        	<span class="keyword">if</span>(w)tr[w].fa=y;</span><br><span class="line">        	tr[y].fa=x,tr[x].fa=z;</span><br><span class="line">        	<span class="built_in">pushup</span>(y);</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="keyword">int</span> st[N];</span><br><span class="line">    	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">splay</span><span class="params">(<span class="keyword">const</span> res &amp;x)</span> </span>&#123;</span><br><span class="line">       	 	res i=x,s=<span class="number">0</span>;</span><br><span class="line">        	st[++s]=x;</span><br><span class="line">        	<span class="keyword">while</span>(<span class="built_in">nroot</span>(i))st[++s]=i=tr[i].fa;</span><br><span class="line">        	res t=tr[st[s]].col;</span><br><span class="line">        	<span class="keyword">while</span>(s)<span class="built_in">pushdown</span>(st[s--]);</span><br><span class="line">        	<span class="keyword">while</span>(<span class="built_in">nroot</span>(x)) &#123;</span><br><span class="line">            	res y=tr[x].fa,z=tr[y].fa;</span><br><span class="line">            	<span class="keyword">if</span>(<span class="built_in">nroot</span>(y))<span class="built_in">rotate</span>((tr[y].son[<span class="number">0</span>]==x)^(tr[z].son[<span class="number">0</span>]==y)?x:y);</span><br><span class="line">            	<span class="built_in">rotate</span>(x);</span><br><span class="line">        	&#125;</span><br><span class="line">        	<span class="built_in">pushup</span>(x);</span><br><span class="line">        	tr[x].col=t;</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">access</span><span class="params">(res x,<span class="keyword">const</span> res &amp;val)</span></span>&#123;</span><br><span class="line">    		res y;</span><br><span class="line">    		<span class="keyword">for</span>(y=<span class="number">0</span>;x;x=tr[y=x].fa)&#123;</span><br><span class="line">    			<span class="built_in">splay</span>(x);</span><br><span class="line">    			res Mn=<span class="number">0</span>,Mx=A.sam[x].len;</span><br><span class="line">    			<span class="keyword">if</span>(tr[x].son[<span class="number">0</span>])Mn=_max(tr[tr[x].son[<span class="number">0</span>]].mn,<span class="number">1</span>);</span><br><span class="line">    			<span class="keyword">else</span> Mn=A.sam[A.sam[x].par].len+<span class="number">1</span>;</span><br><span class="line">    			<span class="keyword">if</span>(tr[x].col)B.<span class="built_in">modify</span>(<span class="number">1</span>,<span class="number">1</span>,n*<span class="number">3</span>,tr[x].col-Mx+<span class="number">1</span>,tr[x].col-Mn+<span class="number">1</span>,<span class="number">-1</span>);</span><br><span class="line">    			tr[tr[x].son[<span class="number">1</span>]].col=tr[x].col,tr[x].son[<span class="number">1</span>]=y,<span class="built_in">pushup</span>(x);</span><br><span class="line">			&#125;</span><br><span class="line">			tr[y].col=val,B.<span class="built_in">modify</span>(<span class="number">1</span>,<span class="number">1</span>,n*<span class="number">3</span>,val-tr[y].mx+<span class="number">1</span>,val,<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">calc</span><span class="params">()</span></span>&#123;</span><br><span class="line">			tr[<span class="number">0</span>].mn=inf;</span><br><span class="line">			<span class="keyword">for</span>(res i=<span class="number">1</span>;i&lt;=A.cnt;i++)&#123;</span><br><span class="line">				tr[i].sz=<span class="number">1</span>,tr[i].fa=A.sam[i].par;</span><br><span class="line">				<span class="keyword">if</span>(i==<span class="number">1</span>)tr[i].mn=tr[i].mnlen=<span class="number">0</span>;</span><br><span class="line">				<span class="keyword">else</span> tr[i].mn=tr[i].mnlen=A.sam[A.sam[i].par].len+<span class="number">1</span>;</span><br><span class="line">				tr[i].mx=tr[i].mxlen=A.sam[i].len;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">for</span>(res i=<span class="number">1</span>;i&lt;=n*<span class="number">3</span>;i++)&#123;</span><br><span class="line">				<span class="built_in">access</span>(pos[i],i);</span><br><span class="line">				<span class="keyword">for</span>(res j=<span class="number">0</span>,sz=vec[i].<span class="built_in">size</span>();j&lt;sz;j++)ans[vec[i][j].se]+=B.<span class="built_in">query</span>(<span class="number">1</span>,<span class="number">1</span>,n*<span class="number">3</span>,vec[i][j].fi,i);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;T;</span><br></pre></td></tr></table></figure></h2><p>好像就没有什么东西要讲了，嗯，这篇总结就这样结束吧。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">foreverlasting</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://foreverlasting1202.github.io/2018/12/01/%E5%90%8E%E7%BC%80%E8%87%AA%E5%8A%A8%E6%9C%BA%E6%80%BB%E7%BB%93/">http://foreverlasting1202.github.io/2018/12/01/后缀自动机总结/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/OI/">OI</a></div><div class="post_share"><div class="social-share" data-image="https://pic.imgdb.cn/item/61fa051f2ab3f51d91b7ee03.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2018/12/15/JSOI2008%E6%B8%B8%E6%88%8F/"><img class="prev-cover" src="https://pic.imgdb.cn/item/61fa03b12ab3f51d91b6c483.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">【JSOI2009】游戏</div></div></a></div><div class="next-post pull-right"><a href="/2018/12/01/CF161D/"><img class="next-cover" src="https://pic.imgdb.cn/item/61f9367d2ab3f51d910e3da2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">【CF161D】Distance in Tree</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/02/28/bijectivepr/" title="A few solutions of bijective proof problems"><img class="cover" src="https://s2.loli.net/2022/02/01/ZGLrd376Kyx9wvE.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-28</div><div class="title">A few solutions of bijective proof problems</div></div></a></div><div><a href="/2022/02/05/loj%E9%9A%8F%E6%9C%BA%E5%81%9A%E9%A2%98/" title="loj 随机做题"><img class="cover" src="https://s2.loli.net/2022/02/01/9BMbc35xJVwjUKr.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-05</div><div class="title">loj 随机做题</div></div></a></div><div><a href="/2021/10/18/%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/" title="做题记录"><img class="cover" src="https://s2.loli.net/2022/02/01/JUVbS8TM9p2FONL.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-18</div><div class="title">做题记录</div></div></a></div><div><a href="/2021/08/10/%E5%8F%A3%E8%83%A1%E8%AE%B0%E5%BD%95/" title="口胡记录"><img class="cover" src="https://pic.imgdb.cn/item/61fb56b62ab3f51d91e9caed.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-10</div><div class="title">口胡记录</div></div></a></div><div><a href="/2021/07/06/%E8%AE%AD%E7%BB%83%E5%AE%9E%E5%BD%95/" title="训练实录"><img class="cover" src="https://pic.imgdb.cn/item/61f9323b2ab3f51d9107fde1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-06</div><div class="title">训练实录</div></div></a></div><div><a href="/2021/06/13/%E5%A4%8D%E5%81%A5%E8%AE%AD%E7%BB%83/" title="复 健 训 练"><img class="cover" src="https://pic.imgdb.cn/item/61fa02dd2ab3f51d91b61b4a.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-13</div><div class="title">复 健 训 练</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/cute.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">foreverlasting</div><div class="author-info__description">呜呜呜。</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">141</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">3</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">40</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/foreverlasting1202" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/573902690@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">现在装了个大概，还有 tag、link 之类的东西没整好，同时文章部分预览也没完成，以后慢慢整吧。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
	struct SAM{
		struct Sam{
			int vis[26],par,len,pos;
		}sam[N&lt;&lt;1];
		int las,rt,cnt;
		SAM() {las&#x3D;rt&#x3D;cnt&#x3D;1;}
		inline void extend(const res &amp;x,const res &amp;id){
            res p&#x3D;las,np&#x3D;++cnt;
            las&#x3D;np,sam[np].len&#x3D;sam[p].len+1,pos[id]&#x3D;las;
            for(;p&amp;&amp;!sam[p].vis[x];p&#x3D;sam[p].par)sam[p].vis[x]&#x3D;np;
            if(!p)sam[np].par&#x3D;rt;
            else {
                res q&#x3D;sam[p].vis[x];
                if(sam[q].len&#x3D;&#x3D;sam[p].len+1)sam[np].par&#x3D;q;
                else {
                    res nq&#x3D;++cnt;
                    memcpy(sam[nq].vis,sam[q].vis,sizeof(sam[nq].vis));
                    sam[nq].len&#x3D;sam[p].len+1;
                    sam[nq].par&#x3D;sam[q].par;
                    sam[q].par&#x3D;sam[np].par&#x3D;nq;
                    for(;p&amp;&amp;sam[p].vis[x]&#x3D;&#x3D;q;p&#x3D;sam[p].par)sam[p].vis[x]&#x3D;nq;
                }
            }
        }
	}A;
	typedef pair&lt;int,int&gt; Pair;
#define mp make_pair
#define fi first
#define se second
	int q;
	LL ans[N];
	vector&lt;Pair&gt; vec[N];
#define pb push_back
	struct Seg{
		LL sum[N&lt;&lt;2];
		int add[N&lt;&lt;2],len[N&lt;&lt;2];
		inline void pushup(const res &amp;rt){
			sum[rt]&#x3D;sum[rt&lt;&lt;1]+sum[rt&lt;&lt;1|1];
		}
		inline void change(const res &amp;rt,const res &amp;val){
			sum[rt]+&#x3D;1LL*val*len[rt],add[rt]+&#x3D;val;
		}
		inline void pushdown(const res &amp;rt){
			if(!add[rt])return;
			change(rt&lt;&lt;1,add[rt]),change(rt&lt;&lt;1|1,add[rt]),add[rt]&#x3D;0;
		}
		void build(const res &amp;rt,const res &amp;l,const res &amp;r){
			len[rt]&#x3D;r-l+1;
			if(l&#x3D;&#x3D;r)return;
			res mid&#x3D;(l+r)&gt;&gt;1;
			build(rt&lt;&lt;1,l,mid),build(rt&lt;&lt;1|1,mid+1,r);
		}
		void modify(const res &amp;rt,const res &amp;l,const res &amp;r,const res &amp;L,const res &amp;R,const res &amp;val){
			if(L&gt;R)return;
			if(L&lt;&#x3D;l&amp;&amp;r&lt;&#x3D;R){change(rt,val);return;}
			pushdown(rt);
			res mid&#x3D;(l+r)&gt;&gt;1;
			if(L&lt;&#x3D;mid)modify(rt&lt;&lt;1,l,mid,L,R,val);
			if(R&gt;mid)modify(rt&lt;&lt;1|1,mid+1,r,L,R,val);
			pushup(rt);
		}
		LL query(const res &amp;rt,const res &amp;l,const res &amp;r,const res &amp;L,const res &amp;R){
			if(L&gt;R)return 0;
			if(L&lt;&#x3D;l&amp;&amp;r&lt;&#x3D;R)return sum[rt];
			pushdown(rt);
			res mid&#x3D;(l+r)&gt;&gt;1;
			LL ret&#x3D;0;
			if(L&lt;&#x3D;mid)ret+&#x3D;query(rt&lt;&lt;1,l,mid,L,R);
			if(R&gt;mid)ret+&#x3D;query(rt&lt;&lt;1|1,mid+1,r,L,R);
			return ret;
		}
	}B;
	struct LCT{
		struct Lct{
			int son[2],sz,fa,mn,mx,mxlen,mnlen,col;
			bool rev;
		}tr[N];
		inline void pushup(const res &amp;x){
			if(!x)return;
			res ls&#x3D;tr[x].son[0],rs&#x3D;tr[x].son[1];
			tr[x].sz&#x3D;tr[ls].sz+tr[rs].sz+1;
			tr[x].mx&#x3D;_max(_max(tr[ls].mx,tr[rs].mx),tr[x].mxlen);
			tr[x].mn&#x3D;_min(_min(tr[ls].mn,tr[rs].mn),tr[x].mnlen);
		}
		inline void reversed(const res &amp;x){
			if(!x)return;
			res &amp;ls&#x3D;tr[x].son[0],&amp;rs&#x3D;tr[x].son[1];
			_swap(ls,rs),tr[x].rev^&#x3D;1;
		}
		inline void pushdown(const res &amp;x){
			if(!x||!tr[x].rev)return;
			res ls&#x3D;tr[x].son[0],rs&#x3D;tr[x].son[1];
			reversed(ls),reversed(rs),tr[x].rev&#x3D;0;
		}
		inline bool nroot(const res &amp;x) {
        	return tr[tr[x].fa].son[0]&#x3D;&#x3D;x||tr[tr[x].fa].son[1]&#x3D;&#x3D;x;
    	}
    	inline void rotate(const res &amp;x) {
        	res y&#x3D;tr[x].fa,z&#x3D;tr[y].fa,k&#x3D;tr[y].son[1]&#x3D;&#x3D;x,w&#x3D;tr[x].son[k^1];
        	if(nroot(y))tr[z].son[tr[z].son[1]&#x3D;&#x3D;y]&#x3D;x;
        	tr[x].son[k^1]&#x3D;y,tr[y].son[k]&#x3D;w;
        	if(w)tr[w].fa&#x3D;y;
        	tr[y].fa&#x3D;x,tr[x].fa&#x3D;z;
        	pushup(y);
    	}
    	int st[N];
    	inline void splay(const res &amp;x) {
       	 	res i&#x3D;x,s&#x3D;0;
        	st[++s]&#x3D;x;
        	while(nroot(i))st[++s]&#x3D;i&#x3D;tr[i].fa;
        	res t&#x3D;tr[st[s]].col;
        	while(s)pushdown(st[s--]);
        	while(nroot(x)) {
            	res y&#x3D;tr[x].fa,z&#x3D;tr[y].fa;
            	if(nroot(y))rotate((tr[y].son[0]&#x3D;&#x3D;x)^(tr[z].son[0]&#x3D;&#x3D;y)?x:y);
            	rotate(x);
        	}
        	pushup(x);
        	tr[x].col&#x3D;t;
    	}
    	inline void access(res x,const res &amp;val){
    		res y;
    		for(y&#x3D;0;x;x&#x3D;tr[y&#x3D;x].fa){
    			splay(x);
    			res Mn&#x3D;0,Mx&#x3D;A.sam[x].len;
    			if(tr[x].son[0])Mn&#x3D;_max(tr[tr[x].son[0]].mn,1);
    			else Mn&#x3D;A.sam[A.sam[x].par].len+1;
    			if(tr[x].col)B.modify(1,1,n*3,tr[x].col-Mx+1,tr[x].col-Mn+1,-1);
    			tr[tr[x].son[1]].col&#x3D;tr[x].col,tr[x].son[1]&#x3D;y,pushup(x);
			}
			tr[y].col&#x3D;val,B.modify(1,1,n*3,val-tr[y].mx+1,val,1);
		}
		inline void calc(){
			tr[0].mn&#x3D;inf;
			for(res i&#x3D;1;i&lt;&#x3D;A.cnt;i++){
				tr[i].sz&#x3D;1,tr[i].fa&#x3D;A.sam[i].par;
				if(i&#x3D;&#x3D;1)tr[i].mn&#x3D;tr[i].mnlen&#x3D;0;
				else tr[i].mn&#x3D;tr[i].mnlen&#x3D;A.sam[A.sam[i].par].len+1;
				tr[i].mx&#x3D;tr[i].mxlen&#x3D;A.sam[i].len;
			}
			for(res i&#x3D;1;i&lt;&#x3D;n*3;i++){
				access(pos[i],i);
				for(res j&#x3D;0,sz&#x3D;vec[i].size();j&lt;sz;j++)ans[vec[i][j].se]+&#x3D;B.query(1,1,n*3,vec[i][j].fi,i);
			}
		}
	}T;
</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/9102/01/01/%E8%BF%91%E6%9C%9F%E6%9B%B4%E6%96%B0%E7%9A%84%E5%8D%9A%E5%AE%A2/" title="近期更新的博客"><img src="https://s2.loli.net/2022/02/01/JUVbS8TM9p2FONL.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="近期更新的博客"/></a><div class="content"><a class="title" href="/9102/01/01/%E8%BF%91%E6%9C%9F%E6%9B%B4%E6%96%B0%E7%9A%84%E5%8D%9A%E5%AE%A2/" title="近期更新的博客">近期更新的博客</a><time datetime="9102-01-01T13:50:00.000Z" title="Created 9102-01-01 21:50:00">9102-01-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/20/CF1654/" title="CF1654"><img src="https://pic.imgdb.cn/item/61fa2e5a2ab3f51d91ddd3cb.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CF1654"/></a><div class="content"><a class="title" href="/2022/03/20/CF1654/" title="CF1654">CF1654</a><time datetime="2022-03-20T15:30:00.000Z" title="Created 2022-03-20 23:30:00">2022-03-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/16/CF1483/" title="CF1483"><img src="https://pic.imgdb.cn/item/61fa039f2ab3f51d91b6b75b.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CF1483"/></a><div class="content"><a class="title" href="/2022/03/16/CF1483/" title="CF1483">CF1483</a><time datetime="2022-03-16T15:30:00.000Z" title="Created 2022-03-16 23:30:00">2022-03-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/14/CF1647/" title="CF1647"><img src="https://pic.imgdb.cn/item/61fa02e92ab3f51d91b6242f.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CF1647"/></a><div class="content"><a class="title" href="/2022/03/14/CF1647/" title="CF1647">CF1647</a><time datetime="2022-03-14T15:30:00.000Z" title="Created 2022-03-14 23:30:00">2022-03-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/12/2022.3.12/" title="2022.3.12"><img src="https://pic.imgdb.cn/item/61fa03542ab3f51d91b678e0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2022.3.12"/></a><div class="content"><a class="title" href="/2022/03/12/2022.3.12/" title="2022.3.12">2022.3.12</a><time datetime="2022-03-11T16:30:00.000Z" title="Created 2022-03-12 00:30:00">2022-03-12</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 By foreverlasting</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Local search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'vBIv3E8Y4e1znLKVs85Y0uSh-gzGzoHsz',
      appKey: 'Dpqs6OR87Ev6XoG6XcSPjToh',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>